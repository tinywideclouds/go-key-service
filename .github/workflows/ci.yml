# .github/workflows/ci.yml

name: 'Build and Push Key Service'

# --- Triggers ---
# This workflow runs on:
# 1. A push to the 'main' branch
# 2. A manual "Run workflow" trigger in the GitHub UI
on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

# --- Environment Variables ---
# Change this to your org/username
env:
  IMAGE_NAME: 'ghcr.io/tinywideclouds/go-key-service'
  MAIN_PACKAGE_PATH: './cmd/keyservice' # The path to the main.go

# --- Permissions ---
# Grants permissions for the GITHUB_TOKEN to:
# 1. Read code (to check it out)
# 2. Write packages (to push to GHCR)
permissions:
  contents: read
  packages: write

# --- Jobs ---
jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1. Get the code from your repo
      - name: 'Checkout code'
        uses: actions/checkout@v4

      # 2. Set up Go environment
      - name: 'Set up Go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.24' # Specify your Go version

      # 3. Run unit tests (Best Practice!)
      # This ensures you don't push a broken image
      - name: 'Run Go Tests'
        run: go test ./...

      # 4. Log in to the GitHub Container Registry (GHCR)
      - name: 'Log in to GHCR'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} # This is auto-generated by GitHub

      # 5. Build and Push image using Google Buildpacks
      # This builds an image tagged with the unique commit SHA
      - name: 'Build and Push Image (SHA)'
        uses: google-github-actions/gcb-buildpack@v2
        with:
          builder: 'gcr.io/buildpacks/builder:v1' # The standard Google builder
          image: '${{ env.IMAGE_NAME }}:${{ github.sha }}' # e.g., ghcr.io/org/repo:a1b2c3d
          path: ${{ env.MAIN_PACKAGE_PATH }}

      # 6. Tag and Push 'latest' (for your E2E test)
      # This step only runs for pushes to the 'main' branch
      - name: 'Tag and Push "latest"'
        if: github.ref == 'refs/heads/main'
        run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.IMAGE_NAME }}:latest
          echo "Pushed latest tag: ${{ env.IMAGE_NAME }}:latest"